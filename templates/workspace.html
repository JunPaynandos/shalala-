<!DOCTYPE html>
<html lang="en">

<head>
  {% load static %}
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Soilution | Workspace</title>
  <link rel="icon" type="image/png" href="{% static 'images/sll2.png' %}" />
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <script src="https://kit.fontawesome.com/a076d05399.js" crossorigin="anonymous"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" />
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.7.1/jquery.min.js"
    integrity="sha512-v2CJ7UaYy4JwqLDIrZUI/4hqeoQieOmAZNXBeQyjo21dadnwR+8ZaIJVT8EE2iyI61OV8e6M8PP2/4hpQINQ/g=="
    crossorigin="anonymous" referrerpolicy="no-referrer"></script>
  <style>
    .btn-cw {
      background: #10ac85;
      border: 1px solid #10ac85;
    }

    .btn-cw:hover {
      border: 1px solid #0d8668;
    }

    .profile-div {
      background: #ccc;
    }

    .overview {
      font-size: 32px;
    }

    button[type="submit"],
    button#closeModal {
      display: inline-block;
      width: 48%;
    }

    .border {
      border: 1.2px solid #aaa;
      border-radius: 5px;
      outline: none;
    }

    .border:focus {
      border-color: #0e9272;
    }

    .new-workspace {
      font-size: 24px;
      font-weight: 600;
    }

    .workspace-desc {
      position: relative;
      top: -10px;
      font-size: 15px;
      color: #6d6c6c;
      margin-bottom: 30px;
    }

    .btn-cancel {
      border: 1px solid #aaa;
    }

    .btn-cancel:hover {
      background-color: rgba(0, 0, 0, 0.4);
      cursor: pointer;
    }

    .btn-create {
      background: #0e9272;
      color: white;
    }

    .btn-create:hover {
      background-color: #0d8668;
      cursor: pointer;
    }

    .hr {
      position: absolute;
      top: 6.8rem;
      left: 0;
      width: 100%;
      border: none;
      border-top: 1px solid #ccc;
    }

    #closeModalX:hover {
      color: black;
    }

    .alert {
      position: absolute;
      right: 20px;
      padding: 10px;
      margin: 10px 0;
      border-radius: 5px;
    }

    .alert-success {
      background-color: #0e9272;
      color: white;
    }

    .alert-danger {
      background-color: #f8d7da;
      color: #721c24;
    }

    #noResultsMessage {
      width: 100%;
      border: 1px solid #ccc;
      background: white;
      padding: 20px 0 20px 20px;
      color: #504f4f;
      border-radius: 5px;
      text-align: left;
    }

    .noResult {
      color: black;
      font-weight: 600;
    }

    #searchBar {
      width: 338px;
    }

    #searchBar:focus {
      border: 1px solid #ccc;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.2);
    }

    .wsm {
      position: absolute;
      top: 23rem;
      left: 50%;
      transform: translateX(-50%);
      display: flex;
      align-items: center;
      justify-content: center;
      width: 50rem;
      text-align: center;
    }

    .truncate {
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
    }

    #workspace-button {
      transition: background-color 0.3s ease;
    }

    #workspace-button:hover {
      background-color: #d1d5db;
    }

    #workspace-button.active {
      background-color: #d1d5db;
    }

    #workspace-dropdown,
    #profile-dropdown {
      border: 1px solid #aaa;
    }

    @keyframes fade-in-down {
      0% {
        opacity: 0;
        transform: translateY(-10px);
      }

      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in-down {
      animation: fade-in-down 0.3s ease-out;
    }

    #searchIcon {
      cursor: default;
      padding: 20px 20px;
    }


    #searchBar {
      visibility: visible;
    }

    /* .overview {
      font-size: 45px;
    } */

    nav {
      background-color: white;
      z-index: 1000;
    }

    #chat-form button {
      width: 80px !important;
    }

    .hide-scrollbar::-webkit-scrollbar {
      display: none;
    }

    /* Hide scrollbar for Firefox */
    .hide-scrollbar {
      scrollbar-width: none;
      -ms-overflow-style: none;
      /* IE/Edge */
    }

    /* Hide scrollbar for Chrome, Safari, Edge */
    #inbox-messages-list::-webkit-scrollbar {
      display: none;
    }

    /* Hide scrollbar for Firefox */
    #inbox-messages-list {
      scrollbar-width: none;
    }

    /* Hide scrollbar for all browsers, but still allow scroll */
    #inbox-messages-list {
      -ms-overflow-style: none;
      /* IE and Edge */
      overflow-y: auto;
      /* Keep scrolling enabled */
    }

    .hide-scrollbar {
      scrollbar-width: none;
      /* Firefox */
      -ms-overflow-style: none;
      /* IE & Edge */
    }

    .hide-scrollbar::-webkit-scrollbar {
      display: none;
      /* Chrome, Safari */
    }

    @media (max-width: 768px) {
      .content-section {
        padding: 0 30px;
      }

      .project-name {
        font-size: 20px !important;
      }

      .project-description {
        font-size: 16px !important;
      }

      .btn-cw {
        position: absolute;
        top: 9rem;
        right: 1.7rem;
      }

      .relative {
        position: relative;
      }

      .search {
        position: absolute;
        top: -8rem;
        right: -18rem;
      }

      #searchIcon {
        position: absolute;
        /* right: -1rem;
        top: 50%; */
        transform: translateY(-50%);
        font-size: 1.5rem;
        cursor: pointer;
        padding: 14px 10px;
        transition: border-color 0.3s ease;
        z-index: 2;
      }

      #searchIcon:hover,
      #searchIcon.active {
        border-radius: 10px;
        font-size: 1.5rem;
      }

      #searchBar {
        position: absolute;
        top: 50%;
        /* right: -1rem; */
        /* Leave room for the icon */
        transform: translateY(-50%);
        width: 0;
        opacity: 0;
        visibility: hidden;
        padding: 14px 10px;
        transition: width 0.3s ease, opacity 0.3s ease, visibility 0s ease 0.3s;
        background-color: white;
        z-index: 1;
      }

      #searchBar.active {
        width: 510px;
        opacity: 1;
        visibility: visible;
        transition: width 0.3s ease, opacity 0.3s ease;
        box-shadow: none;
      }

      /* Optional: border effect when inactive */
      .relative:not(:has(#searchBar.active)) #searchIcon {
        border-color: #ccc;
        border-radius: 10px;
        font-size: 1.5rem;
      }

      /* Optional: clear border when active */
      .relative:has(#searchBar.active) #searchIcon {
        border-color: transparent;
        background-color: transparent;
      }

      #projectList {
        margin: -32px 0 0 0;
      }

      #projectModal {
        /* padding: 0 10px; */
        z-index: 1000;
      }

      #projectModal>div {
        width: 88% !important;
        /* max-width: 300px !important; */
        padding: 1.5rem !important;
      }

      .workspace-desc {
        font-size: 14px !important;
      }

      .hr {
        position: absolute;
        top: 7.3rem;
      }

      form {
        position: relative;
        top: -25px;
        margin-bottom: -20px;
        font-size: 14px;
      }

      #loader svg {
        width: 3rem;
        height: 3rem;
      }

      .modal-desc {
        font-size: 11px !important;
      }

      .wsm {
        display: flex;
        align-items: center;
        justify-content: center;
        width: 80%;
        top: 14rem;
      }

      .wsm p {
        font-size: 16px !important;
      }
    }

    @media (max-width: 452px) {
      #searchIcon {
        right: -5rem;
      }

      #searchBar {
        right: -4.8rem;
      }

      #searchBar.active {
        width: 360px;
      }
    }

    @media (max-width: 375px) {
      #searchIcon {
        right: -2rem;
      }

      #searchBar {
        right: -1.8rem;
      }

      #searchBar.active {
        width: 318px;
      }
    }

    @media (max-width: 370px) {
      #searchIcon {
        right: -1rem;
      }

      #searchBar {
        right: -1rem;
      }

      #searchBar.active {
        width: 305px;
      }
    }

    @media (max-width: 320px) {
      #searchIcon {
        right: 1.6rem;
      }

      #searchBar {
        right: 1.6rem;
      }

      #searchBar.active {
        width: 260px;
      }
    }
  </style>
</head>

<body class="bg-white-100">
  <!-- Navbar -->
  <nav
    class="bg-white sticky top-0 text-black p-1 flex justify-between items-center border-b border-solid border-[#aaa] p-2 pl-0 pr-0">
    <div class="flex items-center ml-7 sm:ml-2">
      <a href="{% url 'workspace' %}"><img src="{% static 'images/sl.png' %}" alt="Logo" class="w-12 h-9 mr-4" /></a>
    </div>

    <!-- right wrapper -->
    <div class="flex items-center gap-x-4 mr-4">
      <!-- Inbox Icon -->
      <div class="relative">
        <a href="#" id="inbox-toggle" class="inbox-link relative flex text-gray-500 hover:text-[#2bdf78]">
          <i class="bi bi-envelope-fill text-xl"></i>
          {% if unread_count > 0 %}
          <span
            class="absolute top-[-6px] right-[-6px] bg-red-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center">
            {{ unread_count }}
          </span>
          {% endif %}
        </a>

        <!-- Messenger like Sidebar -->
        <div id="inbox-sidebar"
          class="hidden fixed top-0 right-0 w-96 h-screen bg-white border-l border-gray-300 shadow-lg z-50 transition-transform transform translate-x-full flex flex-col">
          <!-- sidebar preloader -->
          <div id="loader2" class="hidden fixed inset-0 flex items-center justify-center bg-opacity-70 bg-white z-50">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10" viewBox="0 0 200 200">
              <circle fill="#897F7B" stroke="#897F7B" stroke-width="15" r="15" cx="40" cy="65">
                <animate attributeName="cy" calcMode="spline" dur="2" values="65;135;65;"
                  keySplines=".5 0 .5 1;.5 0 .5 1" repeatCount="indefinite" begin="-.4"></animate>
              </circle>
              <circle fill="#897F7B" stroke="#897F7B" stroke-width="15" r="15" cx="100" cy="65">
                <animate attributeName="cy" calcMode="spline" dur="2" values="65;135;65;"
                  keySplines=".5 0 .5 1;.5 0 .5 1" repeatCount="indefinite" begin="-.2"></animate>
              </circle>
              <circle fill="#897F7B" stroke="#897F7B" stroke-width="15" r="15" cx="160" cy="65">
                <animate attributeName="cy" calcMode="spline" dur="2" values="65;135;65;"
                  keySplines=".5 0 .5 1;.5 0 .5 1" repeatCount="indefinite" begin="0"></animate>
              </circle>
            </svg>
          </div>

          <!-- Header -->
          <div class="flex items-center justify-between p-4 border-b font-semibold text-lg bg-white sticky top-0 z-10">
            <span id="chat-username">Messages</span>
            <button id="close-inbox-sidebar" class="text-gray-500 hover:text-red-500">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <!-- Body that grows to fill available space -->
          <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Message List -->
            <ul id="inbox-messages-list" class="overflow-y-auto flex-1 px-4 py-2 hide-scrollbar">
              <!-- Conversations will load here via AJAX -->
            </ul>

            <div class="px-4 py-6 border-t bg-white text-right">
              <button id="compose-toggle-btn" class="inline-flex gap-1 text-md text-blue-600 hover:underline">Send us a
                message <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-[1em] h-[1em] mt-[3px] mr-1">
                  <path d="M4 22L20 12L4 2V10L16 12L4 14V22Z" />
                </svg>
              </button>
            </div>

            <div id="compose-message" class="hidden p-4 border-t bg-gray-50 mt-[-3rem] h-full">
              <label for="recipient-select"
                class="block text-md font-medium mb-2 outline-none focus:ring-[#0e9272] focus:border-[#0e9272]">Select
                Recipient</label>
              <select id="recipient-select"
                class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-emerald-500">
                <option value="">Select someone to help</option>
              </select>

              <label for="message-content" class="block text-md font-medium mt-4 mb-2">Message</label>
              <textarea id="message-content"
                class="w-full h-[20rem] p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-emerald-500"
                rows="4" placeholder="Write your message..."></textarea>

              <div class="flex justify-end mt-4">
                <button id="send-message-btn"
                  class="bg-emerald-500 hover:bg-emerald-600 text-white py-3 px-8 rounded-lg cursor-pointer" disabled>
                  Send
                </button>
              </div>
            </div>

            <!-- Message Thread -->
            <div id="chat-thread" class="hidden flex-1 overflow-y-auto px-4 py-2 space-y-2 mt-[-3rem] bg-gray-50">
              <button onclick="backToInboxList()" class="text-sm text-blue-600 hover:underline">
                ← Back
              </button>
              <!-- Messages will be dynamically loaded here -->
              <p class="text-sm text-gray-500 text-center">
                Select a conversation
              </p>
              <div id="typing-indicator" class="text-sm text-gray-500 italic px-4 py-1 hidden">
                Typing...
              </div>
            </div>

            <!-- Message Input -->
            <form id="chat-form" class="hidden p-3 border-t flex items-center sticky bottom-0 z-100 bg-white gap-2">
              {% csrf_token %}
              <textarea id="chat-input" placeholder="Type a message..."
                class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 resize-none overflow-y-scroll h-14 max-h-24 leading-snug text-md hide-scrollbar"
                rows="1" style="white-space: pre-wrap; overflow-wrap: break-word;"></textarea>
              <button type="submit"
                class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                Send
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Notification Bell -->
      <div class="relative">
        <button id="bell-button" class="relative flex text-gray-500 hover:text-[#2bdf78] mr-[-12px]">
          <i class="bi bi-bell-fill text-xl"></i>
          <span id="pending-badge"
            class="absolute top-[-5px] right-[5px] bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center hidden">
            0
          </span>
        </button>

        <!-- Dropdown -->
        <div id="notification-dropdown"
          class="absolute right-[-20px] mt-2 w-72 bg-white border border-gray-400 rounded shadow-lg hidden">
          <div class="p-4 border-b text-sm font-semibold text-gray-700">
            Notifications
          </div>
          <ul id="notification-list" class="max-h-60 overflow-y-auto text-sm divide-y divide-gray-100">
            <li class="p-4 text-gray-500 text-center">Loading...</li>
          </ul>

        </div>
      </div>

      <!-- Profile Chip with Dropdown -->
      <div class="relative">
        <div class="flex items-center space-x-2 text-white p-2 rounded-full cursor-pointer" id="profile-button">
          <!-- Avatar -->
          <div class="w-8 h-8 rounded-full overflow-hidden border-2 border-gray-300">
            {% with request.user.profile as my_profile %}
            {% if my_profile.get_profile_image %}
            <img src="{{ my_profile.get_profile_image }}" alt="User Avatar" class="w-full h-full object-cover" />
            {% else %}
            <span class="...">
              {{ request.user.first_name|slice:":1"|upper }}{{
              request.user.last_name|slice:":1"|upper }}
            </span>
            {% endif %}
            {% endwith %}
          </div>
        </div>

        <!-- Dropdown Menu -->
        <div id="profile-dropdown"
          class="absolute right-[-8px] md:right-0 hidden bg-white text-black rounded shadow-md w-48 z-10 p-1 mr-2">
          <ul class="py-2">
            <li class="px-4 py-2 text-m text-black-600">
              <strong>{{ user.first_name }}</strong> <br />
              <span class="text-sm text-gray-500 truncate" style="max-width: 150px; display: inline-block">
                {{ user.email }}
              </span>
            </li>
            <li>
              <a href="{% url 'account_settings' %}?next={{ request.path }}"
                class="block px-4 py-2 hover:bg-gray-200">Account settings</a>
            </li>
            <li>
              <a href="{% url 'logout' %}" class="block px-4 py-2 hover:bg-gray-200">Log Out</a>
            </li>
          </ul>
        </div>
      </div>
    </div>
  </nav>

  <!-- message -->
  <div id="message-container"></div>

  <!-- Content Section -->
  <div class="w-full mx-auto sm:px-16 md:px-32 mt-8 mb-16 content-section">
    <!-- <h2 class="text-6xl font-bold mb-5 overview">Overview</h2> -->
    <h2 class="text-3xl sm:text-3xl md:text-4xl lg:text-6xl font-semibold mb-12 mt-20">Workspace</h2>

    <div class="flex items-center gap-4 mb-4">
      <button class="text-white px-4 py-2 md:px-8 md:py-4 rounded btn-cw md:right-[8rem]" id="openModal">
        <span class="block md:hidden text-xl font-bold">+</span> <!-- Show only on small screens -->
        <span class="hidden md:inline">New Workspace</span>
      </button>
      <div class="relative search">
        <!-- Magnifying Glass Icon -->
        <i class="bi bi-search absolute text-gray-500 cursor-pointer md:right-[-14rem] lg:right-[17.5rem]"
          style="font-size: 0.9rem" id="searchIcon" onclick="toggleSearchBar()"></i>

        <!-- Search Bar -->
        <input type="text"
          class="w-[21.5rem] border border-gray-300 pl-14 p-4 transition-all duration-300 ease-in-out md:right-[-14rem]"
          placeholder="Search for a workspace" id="searchBar" onkeyup="filterProjects()" autocomplete="off" />
      </div>
    </div>

    <div id="noResultsMessage" class="text-center mt-8 hidden">
      <!-- This message will appear if no results are found -->
    </div>

    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6" id="projectList">
      {% if workspace %} {% for workspace in workspace %}
      <a href="{% url 'dashboard' %}?workspace={{ workspace.id }}">
        <div
          class="group bg-white shadow p-8 rounded-lg transition duration-300 border border-gray-300 hover:border-gray-400 hover:bg-gray-200 h-[180px] cursor-pointer project-item flex flex-col justify-between relative"
          data-id="{{ workspace.id }}">
          <h6
            class="font-semibold text-xl md:text-2xl project-name truncate w-40 md:w-20 lg:w-[8rem] xl:w-60 pb-3 overflow-ellipsis whitespace-nowrap">
            {{ workspace.name }}
          </h6>
          <p
            class="text-gray-500 text-sm lg:text-[18px] project-description overflow-hidden w-full overflow-ellipsis whitespace-normal break-words flex-grow max-w-[85%]">
            <span id="description">
              {% if workspace.description %} {{ workspace.description }} {% else %}{% endif %}
            </span>
          </p>
          <span
            class="absolute top-4 right-7 p-4 text-gray-600 transition-all duration-300 ease-in-out group-hover:text-black group-hover:translate-x-3">
            <svg class="arrow-icon transform transition-transform duration-300 ease-in-out" width="36px" height="36px"
              viewBox="0 0 100 125" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
              <g>
                <path fill="currentColor"
                  d="M37.556,29.177c7.853,7.164,15.706,14.327,23.56,21.491c3.564,3.251,8.884-2.038,5.303-5.304
                    C58.565,38.2,50.712,31.037,42.859,23.873C39.295,20.622,33.976,25.911,37.556,29.177L37.556,29.177z" />
              </g>
              <g>
                <path fill="currentColor"
                  d="M61.039,45.364c-7.803,7.802-15.605,15.605-23.407,23.408c-3.422,3.423,1.881,8.726,5.304,5.303
                    c7.802-7.802,15.604-15.604,23.406-23.407C69.765,47.245,64.462,41.941,61.039,45.364L61.039,45.364z" />
              </g>
            </svg>
          </span>
        </div>
      </a>
      {% endfor %} {% else %}
      <div class="text-center wsm no-workspace-message">
        <p class="text-md md:text-2xl mt-[6rem] text-justify md:text-center font-semibold text-gray-400">
          Organize your soil management process by creating a workspace to
          stay productive and on track. Create your workspace now and start
          managing your soil effectively!
        </p>
      </div>
      {% endif %}
    </div>
  </div>

  <!-- Preloader -->
  <div id="loader" class="hidden fixed inset-0 flex items-center justify-center bg-opacity-70 bg-white z-50">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" class="w-20 h-20 animate-spin">
      <radialGradient id="a9" cx=".66" fx=".66" cy=".3125" fy=".3125" gradientTransform="scale(1.5)">
        <stop offset="0" stop-color="#888"></stop>
        <stop offset=".3" stop-color="#888" stop-opacity=".9"></stop>
        <stop offset=".6" stop-color="#888" stop-opacity=".6"></stop>
        <stop offset=".8" stop-color="#888" stop-opacity=".3"></stop>
        <stop offset="1" stop-color="#888" stop-opacity="0"></stop>
      </radialGradient>
      <circle transform-origin="center" fill="none" stroke="url(#a9)" stroke-width="30" stroke-linecap="round"
        stroke-dasharray="200 1000" stroke-dashoffset="0" cx="100" cy="100" r="70">
        <animateTransform type="rotate" attributeName="transform" calcMode="spline" dur="2" values="360;0"
          keyTimes="0;1" keySplines="0 0 1 1" repeatCount="indefinite"></animateTransform>
      </circle>
      <circle transform-origin="center" fill="none" opacity=".2" stroke="#888" stroke-width="30" stroke-linecap="round"
        cx="100" cy="100" r="70"></circle>
    </svg>
  </div>

  <!-- Modal -->
  <div id="projectModal" class="fixed inset-0 bg-black bg-opacity-50 hidden flex items-center justify-center">
    <div class="bg-white max-w-full p-8 rounded-lg shadow-2xl relative">
      <button id="closeModalX" class="absolute top-2 right-2 text-3xl text-gray-500">
        &times;
      </button>

      <h1 class="text-2xl mb-4 new-workspace">New Workspace</h1>
      <p class="workspace-desc mb-4 text-gray-600 text-lg">
        Workspace organizes your process and makes soil management easier.
      </p>
      <hr class="hr mb-6" />
      <form id="projectForm" method="POST" action="{% url 'add_workspace' %}">
        <label class="mb-2 block font-semibold text-md md:text-lg">Name</label>
        <input type="text" id="projectName" name="name" class="border p-3 rounded w-full mb-6 text-lg"
          autocomplete="off" required />
        <label class="mb-2 block font-semibold text-md md:text-lg">Description
          <span class="text-gray-500 text-xs md:text-lg modal-desc">(optional | max. of 100 characters)</span></label>
        <textarea id="projectDescription" name="description" class="border p-6 rounded w-full mb-4 text-lg"
          autocomplete="off"></textarea>
        <input type="hidden" name="csrfmiddlewaretoken" value="{{ csrf_token }}" />

        <div class="flex justify-between mt-4">
          <button type="button" id="closeModal" class="text-black-500 px-5 py-3 rounded btn-cancel text-lg flex-1 mr-2">
            Cancel
          </button>
          <button type="submit" class="px-5 py-3 rounded btn-create text-lg flex-1 ml-2">
            Create
          </button>
        </div>

      </form>
    </div>
  </div>

  <!-- <script>
    function toggleSidebar() {
      document.getElementById("sidebar").classList.toggle("w-20");
    }

    const profileButton = document.getElementById("profile-button");
    const profileDropdown = document.getElementById("profile-dropdown");

    profileButton.addEventListener("click", () => {
      if (profileDropdown.classList.contains("hidden")) {
        profileDropdown.classList.remove("hidden");
        profileDropdown.classList.add("animate-fade-in-down");

        // Remove animation class after it's done to allow re-adding it later
        setTimeout(() => {
          profileDropdown.classList.remove("animate-fade-in-down");
        }, 300);
      } else {
        profileDropdown.classList.add("hidden");
      }
    });

    document.addEventListener("click", (event) => {
      if (
        !profileButton.contains(event.target) &&
        !profileDropdown.contains(event.target)
      ) {
        profileDropdown.classList.add("hidden");
      }
    });
  </script> -->

  <script>
    const currentUserId = "{{ request.user.id }}";
    console.log(currentUserId);
  </script>

  <script>
    $(document).ready(function () {
      $("#openModal").click(function () {
        $("#projectModal").removeClass("hidden");
        $("#projectName").val("");
        $("#projectDescription").val("");
      });

      $("#closeModalX, #closeModal").click(function () {
        $("#projectModal").addClass("hidden");
        $("#projectName").val("");
        $("#projectDescription").val("");
      });

      $("#projectForm").submit(function (e) {
        e.preventDefault();
        let name = $("#projectName").val();
        let description = $("#projectDescription").val();

        $("#loader").removeClass("hidden");

        $.ajax({
          type: "POST",
          url: "{% url 'add_workspace' %}",
          data: {
            name: name,
            description: description,
            csrfmiddlewaretoken: "{{ csrf_token }}",
          },
          success: function (response) {
            console.log("Success Response:", response);
            if (response.success) {
              $("#loader").addClass("hidden");
              $("#projectModal").addClass("hidden");

              $("#message-container").html(`
                  <div class="alert alert-success">
                    ${response.message}
                  </div>
                `);

              setTimeout(function () {
                $("#message-container").html("");
              }, 5000);

              // Check if description is empty or null
              let workspaceDescription = response.workspace.description
                ? response.workspace.description
                : "";

              // Dynamically add the new workspace to the list
              let newWorkspace = `
                  <a href="{% url 'dashboard' %}?workspace=${response.workspace.id}">
                    <div
                      class="group bg-white shadow p-8 rounded-lg transition duration-300 border border-gray-300 hover:border-gray-400 hover:bg-gray-200 h-[180px] cursor-pointer project-item flex flex-col justify-between relative"
                      data-id="${response.workspace.id}" data-created-at="${response.workspace.created_at}"
                    >
                      <h6 class="font-semibold text-2xl project-name">${response.workspace.name}</h6>
                      <p class="text-gray-500 text-lg mt-4 project-description overflow-hidden overflow-ellipsis whitespace-normal break-words flex-grow max-w-[85%]">
                        <span id="description">${workspaceDescription}</span>
                      </p>
                      <span class="absolute top-4 right-7 p-4 text-gray-600 transition-all duration-300 ease-in-out group-hover:text-black group-hover:translate-x-3">
                        <svg class="arrow-icon transform transition-transform duration-300 ease-in-out" width="36px" height="36px" viewBox="0 0 100 125" xmlns="http://www.w3.org/2000/svg" fill="currentColor">
                          <g>
                            <path fill="currentColor" d="M37.556,29.177c7.853,7.164,15.706,14.327,23.56,21.491c3.564,3.251,8.884-2.038,5.303-5.304 C58.565,38.2,50.712,31.037,42.859,23.873C39.295,20.622,33.976,25.911,37.556,29.177L37.556,29.177z"/>
                          </g>
                          <g>
                            <path fill="currentColor" d="M61.039,45.364c-7.803,7.802-15.605,15.605-23.407,23.408c-3.422,3.423,1.881,8.726,5.304,5.303 c7.802-7.802,15.604-15.604,23.406-23.407C69.765,47.245,64.462,41.941,61.039,45.364L61.039,45.364z"/>
                          </g>
                        </svg>
                      </span>
                    </div>
                  </a>
                `;

              $("#projectList").prepend(newWorkspace);

              $(".no-workspace-message").remove();

              let newWorkspaceOption = document.createElement("div");
              newWorkspaceOption.classList.add("workspace-option");
              newWorkspaceOption.setAttribute(
                "data-name",
                response.workspace.name
              );
              newWorkspaceOption.textContent = response.workspace.name;

              workspaceDropdown.appendChild(newWorkspaceOption);

              let workspaces = $("#projectList > div").get();
              workspaces.sort(function (a, b) {
                let idA = $(a).data("id");
                let idB = $(b).data("id");

                return idB - idA; // Sort in descending order based on `id`
              });

              $("#projectList").html(workspaces);

              filterProjects();

              $("#projectName").val("");
              $("#projectDescription").val("");
            } else {
              $("#loader").addClass("hidden");
              $("#message-container").html(`
                  <div class="alert alert-danger">
                    Error creating workspace: Please check your input.
                  </div>
                `);

              setTimeout(function () {
                $("#message-container").html("");
              }, 5000);
            }
          },
          error: function (xhr, status, error) {
            console.log("Error: " + error);
            $("#loader").addClass("hidden");
            $("#message-container").html(`
                <div class="alert alert-danger">
                  An error occurred while creating the workspace. Please try again.
                </div>
              `);

            setTimeout(function () {
              $("#message-container").html("");
            }, 5000);
          },
        });
      });
    });
  </script>

  <!-- hide modal-->
  <script>
    // Close modal when clicking the X button
    document
      .getElementById("closeModalX")
      .addEventListener("click", function () {
        document.getElementById("projectModal").classList.add("hidden");
      });

    // Close modal when clicking the Cancel button
    document
      .getElementById("closeModal")
      .addEventListener("click", function () {
        document.getElementById("projectModal").classList.add("hidden");
      });
  </script>

  <!-- search bar func in small screen -->
  <script>
    function toggleSearchBar() {
      const searchBar = document.querySelector("#searchBar");
      const searchIcon = document.querySelector("#searchIcon");

      // Toggle the search bar visibility
      searchBar.classList.toggle("active");

      const isSmallScreen = window.innerWidth <= 768; // Tailwind's 'md' breakpoint is 768px

      if (isSmallScreen) {
        // If on small screens, toggle icon and styling
        if (searchBar.classList.contains("active")) {
          searchIcon.style.fontSize = "1.5rem";
          searchIcon.classList.remove("bi-search");
          searchIcon.classList.add("bi-x", "text-gray-800");
          searchBar.focus();
        } else {
          searchIcon.style.fontSize = "0.9rem";
          searchIcon.classList.remove("bi-x", "text-gray-800");
          searchIcon.classList.add("bi-search");
        }
      }

      // If the search bar is being closed, clear the input
      if (!searchBar.classList.contains("active")) {
        searchBar.value = "";
        filterProjects(); // Reset search results
      }
    }
  </script>


  <!-- search bar functionality -->
  <script>
    function filterProjects() {
      let query = document.querySelector("#searchBar").value.toLowerCase();
      let workspaces = document.querySelectorAll("#projectList > a");
      let found = false;

      // Loop through all workspaces
      workspaces.forEach(function (workspace) {
        let name = workspace.querySelector("h6").textContent.toLowerCase();
        let description = workspace
          .querySelector("p")
          .textContent.toLowerCase();

        // Check if name or description contains the search query
        if (name.includes(query) || description.includes(query)) {
          workspace.style.display = "block";
          found = true;
        } else {
          workspace.style.display = "none";
        }
      });

      let noResultsMessage = document.getElementById("noResultsMessage");

      // Show "No results found" message if no match was found and the query is not empty
      if (!found && query.length > 0) {
        noResultsMessage.classList.remove("hidden");
        noResultsMessage.innerHTML = `
      <span class="noResult">No results found</span> <br> 
      Your search for "<strong>${query}</strong>" did not return any results.
    `;
      } else {
        // Hide "No results found" message if a match was found or query is empty
        noResultsMessage.classList.add("hidden");
      }
    }    
  </script>

  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const loader = document.getElementById("loader");
      const sidebarLinks = document.querySelectorAll("#projectList a");

      sidebarLinks.forEach((link) => {
        link.addEventListener("click", () => {
          loader.classList.remove("hidden"); // Show the preloader
        });
      });
    });
  </script>

  <script>
    window.addEventListener("pageshow", function (event) {
      // Always hide the loader when coming back to this page
      const loader = document.getElementById("loader");
      if (loader) {
        loader.classList.add("hidden");
      }
    });
  </script>


  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const profileButton = document.getElementById("profile-button");
      const profileDropdown = document.getElementById("profile-dropdown");
      // const workspaceButton = document.getElementById("workspace-button");
      // const workspaceDropdown = document.getElementById("workspace-dropdown");
      const inboxToggle = document.getElementById("inbox-toggle");
      const inboxDropdown = document.getElementById("inbox-dropdown");
      const inboxSidebar = document.getElementById("inbox-sidebar");
      const loader = document.getElementById("loader");
      const sidebarLinks = document.querySelectorAll("#sidebar a");
      const composeMessageDiv = document.getElementById("compose-message");
      const recipientSelect = document.getElementById("recipient-select");
      const messageContent = document.getElementById("message-content");
      const sendMessageBtn = document.getElementById("send-message-btn");
      const composeBtn = document.getElementById("compose-toggle-btn");
      const bellButton = document.getElementById("bell-button");
      const bellDropdown = document.getElementById("notification-dropdown");

      let currentChatUserId = null;

      // Scroll to bottom of chat
      function scrollToBottom() {
        const chatThread = document.getElementById("chat-thread");
        if (chatThread) {
          chatThread.scrollTop = chatThread.scrollHeight;
        }
      }

      // Dropdown setup functions
      function hideAllDropdowns() {
        profileDropdown.classList.add("hidden");
        // workspaceDropdown.classList.add("hidden");
        bellDropdown.classList.add("hidden");
        if (inboxDropdown) inboxDropdown.classList.add("hidden");
      }

      function setupDropdown(button, dropdown, onOpenCallback) {
        if (!button || !dropdown) return;
        button.addEventListener("click", function (e) {
          e.stopPropagation();
          const isHidden = dropdown.classList.contains("hidden");
          hideAllDropdowns();
          if (isHidden) {
            // Apply the animation and make dropdown visible
            dropdown.classList.remove("hidden");
            dropdown.classList.add("animate-fade-in-down");
            setTimeout(
              () => dropdown.classList.remove("animate-fade-in-down"),
              300
            ); // Remove animation class after 300ms
          }
          if (typeof onOpenCallback === "function") {
            onOpenCallback();
          }
        });
      }

      // setupDropdown(workspaceButton, workspaceDropdown);
      setupDropdown(profileButton, profileDropdown);
      // setupDropdown(bellButton, bellDropdown, fetchPendingAccounts);
      setupDropdown(bellButton, bellDropdown);
      if (inboxToggle && inboxDropdown) {
        setupDropdown(inboxToggle, inboxDropdown);
      }

      document.addEventListener("click", function (e) {
        if (
          !profileButton.contains(e.target) &&
          !profileDropdown.contains(e.target) &&
          !bellButton?.contains(e.target) &&
          !bellDropdown?.contains(e.target) &&
          (!inboxToggle || !inboxToggle.contains(e.target)) &&
          (!inboxDropdown || !inboxDropdown.contains(e.target))
        ) {
          hideAllDropdowns();
        }
      });

      if (loader) {
        sidebarLinks.forEach((link) => {
          link.addEventListener("click", () => {
            loader.classList.remove("hidden");
          });
        });

        window.addEventListener("pageshow", () => {
          loader.classList.add("hidden");
        });
      }

      updateInboxDropdown();

      if (inboxToggle && inboxSidebar) {
        inboxToggle.addEventListener("click", function (e) {
          e.preventDefault();
          updateInboxDropdown();
          inboxSidebar.classList.remove("hidden", "translate-x-full");
        });
      }

      const closeBtn = document.getElementById("close-inbox-sidebar");
      if (closeBtn) {
        closeBtn.addEventListener("click", function () {
          inboxSidebar.classList.add("translate-x-full");
          setTimeout(() => {
            inboxSidebar.classList.add("hidden");
          }, 300);
        });
      }

      function updateInboxDropdown() {
        $.ajax({
          url: "{% url 'ajax_messages_status' %}",
          method: "GET",
          success: function (data) {
            const badge = $("#inbox-toggle span");
            const count = data.unread_count;

            if (count > 0) {
              if (badge.length > 0) {
                badge.text(count);
              } else {
                $("#inbox-toggle").append(`
                    <span class="absolute top-[-6px] right-[-6px] bg-red-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center">
                      ${count}
                    </span>
                  `);
              }
            } else {
              badge.remove();
            }

            const inboxList = $("#inbox-messages-list");
            inboxList.empty();

            if (data.messages.length > 0) {
              const uniqueSenders = {};

              // Loop through messages to collect the latest message per sender
              data.messages.forEach((msg) => {
                if (!uniqueSenders[msg.sender_id]) {
                  uniqueSenders[msg.sender_id] = msg;
                }
              });

              Object.values(uniqueSenders).forEach((msg) => {
                inboxList.append(`
                    <li class="p-2 border-b hover:bg-gray-100 cursor-pointer flex items-start space-x-2 rounded ${msg.is_read ? "bg-white" : "bg-green-50"
                  }"
                        onclick="openMessage(${msg.sender_id}, '${msg.sender
                  }')">
                      <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 border border-gray-300 bg-gray-200 flex items-center justify-center text-sm font-semibold text-white">
                        ${msg.sender_avatar
                    ? `<img src="${msg.sender_avatar}" alt="Avatar" class="w-full h-full object-cover">`
                    : `<span class="bg-gray-500 w-full h-full flex items-center justify-center">${msg.sender_initials}</span>`
                  }
                      </div>
                      <div class="flex flex-col w-full truncate text-ellipsis">
                        <div class="flex justify-between items-center">
                          <strong class="${msg.is_read
                    ? "text-gray-600"
                    : "text-black font-semibold"
                  }">${msg.sender}</strong>
                          ${msg.is_read
                    ? ""
                    : '<span class="text-xs text-green-600 font-semibold">• New</span>'
                  }
                        </div>
                        <div class="text-sm text-gray-600 whitespace-nowrap overflow-hidden w-full truncate text-ellipsis">${msg.content
                  }</div>
                        <small class="text-xs text-gray-400">${msg.timestamp
                  }</small>
                      </div>
                    </li>
                  `);
              });
            } else {
              inboxList.html(
                '<p class="flex flex-col items-center justify-center h-full min-h-[200px] text-center text-lg text-gray-500 p-3">No messages<br><span class="text-sm mt-1">Messages from the team will be shown here</span></p>'
              );
            }
          },
          error: function () {
            console.error("Failed to fetch messages");
          },
        });
      }

      window.openMessage = function (senderId, username) {
        currentChatUserId = senderId;
        $("#inbox-messages-list").addClass("hidden");
        $("#chat-thread").removeClass("hidden").empty();
        $("#chat-form").removeClass("hidden");
        $("#compose-toggle-btn").addClass("hidden");
        $("#chat-username").html(`
            <button onclick="backToInboxList()" class="text-sm text-blue-600 hover:underline mr-2">← Back</button>
            ${username}
          `);

        // Mark messages as read
        fetch(`/messages/mark_read/${senderId}/`)
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "ok") {
              // Refresh the dropdown to update UI (badge, background, dot)
              updateInboxDropdown();
            }
          });

        loadConversation(senderId);
      };

      window.backToInboxList = function () {
        currentChatUserId = null;
        $("#chat-thread").addClass("hidden").empty();
        $("#chat-form").addClass("hidden");
        $("#compose-message").addClass("hidden");
        $("#inbox-messages-list").removeClass("hidden");
        $("#chat-username").text("Messages");
        $("#compose-toggle-btn").removeClass("hidden");
      };

      function loadConversation(senderId) {
        const chatThread = $("#chat-thread");

        // Show preloader before loading content
        $("#loader2").removeClass("hidden");

        // Optional: clear chat thread for better transition
        chatThread.empty();

        // MutationObserver will monitor chatThread
        const observer = new MutationObserver((mutationsList, observer) => {
          if (chatThread.children().length > 0) {
            // Content added, hide the preloader
            $("#loader2").addClass("hidden");
            observer.disconnect(); // Stop observing
          }
        });

        // Start observing for child changes
        observer.observe(chatThread[0], { childList: true });

        $.ajax({
          url: `/messages/thread/${senderId}/`,
          method: "GET",
          success: function (data) {
            const chatThread = $("#chat-thread");
            chatThread.empty();

            if (data.messages && data.messages.length > 0) {
              data.messages.forEach((msg) => {
                const isCurrentUser = msg.sender_id == currentUserId;

                if (isCurrentUser) {
                  // Your message on the right
                  chatThread.append(`
                      <div class="flex justify-end">
                        <div class="max-w-[70%] rounded-lg px-4 py-2 my-1 bg-emerald-500 text-white" style="word-wrap: break-word; overflow-wrap: break-word;">
                          <span style="overflow-wrap:anywhere; white-space:pre-wrap; display:block; width:100%;">${msg.content}</span>
                          <div class="text-xs text-right opacity-70 mt-1">${msg.timestamp}</div>
                        </div>
                      </div>
                    `);
                } else {
                  // Other user's message on the left
                  const avatar = msg.sender_avatar
                    ? `<img src="${msg.sender_avatar}" alt="Avatar" class="w-full h-full object-cover">`
                    : `<div class="bg-gray-400 text-white w-full h-full flex items-center justify-center text-xs font-semibold rounded-full">👤</div>`;

                  chatThread.append(`
                      <div class="flex items-start space-x-2 my-2">
                        <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 border border-gray-300">
                          ${avatar}
                        </div>
                        <div class="bg-gray-200 text-black max-w-[70%] px-4 py-2 rounded-lg" style="word-wrap: break-word; overflow-wrap: break-word;">
                          <span style="overflow-wrap:anywhere; white-space:pre-wrap; display:block; width:100%;">${msg.content}</span>
                          <div class="text-xs text-right opacity-70 mt-1">${msg.timestamp}</div>
                        </div>
                      </div>
                    `);
                }
              });
            } else {
              chatThread.html(
                '<p class="text-sm text-gray-500 text-center">No messages in this thread.</p>'
              );
              $("#loader").addClass("hidden"); // Still hide loader on failure
              observer.disconnect();
            }

            scrollToBottom();
          },
          error: function () {
            console.error("Failed to load conversation.");
            $("#chat-thread").html(
              '<p class="text-sm text-red-500 text-center">Could not load messages.</p>'
            );
          },
        });
      }

      const inboxSocket = new WebSocket(
        // "ws://" + window.location.host + "/ws/inbox/"
        (window.location.protocol === "https:" ? "wss://" : "ws://") + window.location.host + "/ws/inbox/"
      );
      inboxSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        if (data.type === "new_message") {
          // if (!currentUserId) {
          //   updateInboxDropdown();
          // }

          updateInboxDropdown();

          const msg = data.message;
          if (
            // currentChatUserId &&
            // parseInt(currentChatUserId) === msg.sender_id

            currentChatUserId &&
            (parseInt(currentChatUserId) === msg.sender_id ||
              parseInt(currentChatUserId) === msg.recipient_id)
          ) {
            const isCurrentUser = msg.sender_id == currentUserId;

            if (isCurrentUser) {
              $("#chat-thread").append(`
                  <div class="flex justify-end">
                    <div class="max-w-[70%] rounded-lg px-4 py-2 my-1 bg-emerald-500 text-white" style="word-wrap: break-word; overflow-wrap: break-word;">
                      <span style="word-wrap: break-word; overflow-wrap: break-word;">${msg.content}</span>
                      <div class="text-xs text-right opacity-70 mt-1">${msg.timestamp}</div>
                    </div>
                  </div>
                `);
            } else {
              const avatar = msg.sender_avatar
                ? `<img src="${msg.sender_avatar}" alt="Avatar" class="w-full h-full object-cover">`
                : `<div class="bg-gray-400 text-white w-full h-full flex items-center justify-center text-xs font-semibold rounded-full">👤</div>`;
              console.log("Avatar URL: ", msg.sender_avatar);
              $("#chat-thread").append(`
                  <div class="flex items-start space-x-2 my-2">
                    <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 border border-gray-300">
                      ${avatar}
                    </div>
                    <div class="bg-gray-200 text-black max-w-[70%] px-4 py-2 rounded-lg" style="word-wrap: break-word; overflow-wrap: break-word;">
                      <span style="word-wrap: break-word; overflow-wrap: break-word;">${msg.content}</span>
                      <div class="text-xs text-right opacity-70 mt-1">${msg.timestamp}</div>
                    </div>
                  </div>
                `);
            }

            // $('#chat-thread').scrollTop($('#chat-thread')[0].scrollHeight);
            scrollToBottom();
          } else {
            // If not in that thread, update inbox preview
            updateInboxDropdown();
          }
        }
      };

      inboxSocket.onopen = function () {
        console.log("WebSocket connected");
      };

      inboxSocket.onclose = function () {
        console.warn("WebSocket closed unexpectedly");
      };

      // SEND MESSAGE HANDLER
      const chatForm = document.getElementById("chat-form");
      const chatInput = document.getElementById("chat-input");

      function getCSRFToken() {
        // return document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        const csrfTokenElement = document.querySelector(
          "[name=csrfmiddlewaretoken]"
        );
        return csrfTokenElement ? csrfTokenElement.value : "";
      }

      if (chatForm) {
        chatForm.addEventListener("submit", function (e) {
          e.preventDefault();
          const message = chatInput.value.trim();
          if (!message || !currentChatUserId) return;

          // Ensure CSRF token is correctly attached
          const csrfToken = getCSRFToken(); // Get the CSRF token
          if (!csrfToken) {
            console.error("CSRF token missing");
            return; // Don't proceed without CSRF token
          }

          fetch(`/messages/send/${currentChatUserId}/`, {
            method: "POST",
            headers: {
              "X-CSRFToken": csrfToken,
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `message=${encodeURIComponent(message)}`,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.status === "ok") {
                $("#chat-thread").append(`
                  <div class="flex justify-end">
                    <div class="max-w-[70%] rounded-lg px-4 py-2 my-1 bg-emerald-500 text-white" style="word-wrap: break-word; overflow-wrap: break-word;">
                      <span style="word-wrap: break-word; overflow-wrap: break-word;">${message}</span>
                      <div class="text-xs text-right opacity-70 mt-1">${new Date().toLocaleTimeString(
                  [],
                  { hour: "2-digit", minute: "2-digit" }
                )}</div>
                    </div>
                  </div>
                `);
                chatInput.value = "";
                // $('#chat-thread').scrollTop($('#chat-thread')[0].scrollHeight);
                scrollToBottom();
              } else {
                alert("Failed to send message");
              }
            })
            .catch((err) => {
              console.error("Send failed", err);
            });
        });
      }

      composeBtn.addEventListener("click", function () {
        // Hide inbox list and thread
        document.getElementById("inbox-messages-list").classList.add("hidden");
        document.getElementById("chat-thread").classList.add("hidden");
        document.getElementById("chat-form").classList.add("hidden");
        document.getElementById("compose-toggle-btn").classList.add("hidden");

        // Show compose form
        composeMessageDiv.classList.remove("hidden");

        // Reset form
        recipientSelect.value = "";
        messageContent.value = "";
        sendMessageBtn.disabled = true;

        // Optional: update header
        document.getElementById("chat-username").innerHTML = `
            <button onclick="backToInboxList()" class="text-sm text-blue-600 hover:underline mr-2">← </button>
            Compose New Message
          `;
      });

      // Fetch admin users to populate the recipient select dropdown
      function loadAdminUsers() {
        fetch('/get_admin_users/')  // URL for the new view
          .then(response => response.json())
          .then(data => {
            const admins = data.admins;
            recipientSelect.innerHTML = '<option value="">Select one of our team to help</option>';  // Reset dropdown

            admins.forEach(admin => {
              recipientSelect.innerHTML += `<option value="${admin.id}">${admin.username}</option>`;
            });
          })
          .catch(error => console.error("Error loading admin users:", error));
      }

      // Enable the send button if both recipient and message content are provided
      function checkFormValidity() {
        const recipientId = recipientSelect.value;
        const message = messageContent.value.trim();
        sendMessageBtn.disabled = !(recipientId && message);
      }

      // Listen for changes in the recipient or message content
      recipientSelect.addEventListener("change", checkFormValidity);
      messageContent.addEventListener("input", checkFormValidity);

      // Send the message when the button is clicked
      sendMessageBtn.addEventListener("click", function () {
        const recipientId = recipientSelect.value;
        const message = messageContent.value.trim();

        if (recipientId && message) {
          const csrfToken = getCSRFToken();  // Ensure CSRF token is attached

          fetch(`/messages/send/${recipientId}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `message=${encodeURIComponent(message)}`
          })
            .then(response => response.json())
            .then(data => {
              if (data.status === 'ok') {
                const recipientId = data.recipient_id || recipientSelect.value;
                const recipientUsername = recipientSelect.options[recipientSelect.selectedIndex].text;

                // Hide compose, show thread
                composeMessageDiv.classList.add("hidden");
                $('#inbox-messages-list').addClass('hidden');
                $('#chat-thread').removeClass('hidden').empty();
                $('#chat-form').removeClass('hidden');

                // Set current chat state
                currentChatUserId = recipientId;
                $('#chat-username').html(`
            <button onclick="backToInboxList()" class="text-sm text-blue-600 hover:underline mr-2">← Back</button>
            ${recipientUsername}
          `);

                // Load the conversation
                loadConversation(recipientId);
              } else {
                alert('Failed to send message');
              }
            })
            .catch(err => {
              console.error('Send failed', err);
            });
        }
      });

      // Load admin users when the page is loaded
      loadAdminUsers();
    });
  </script>

  <!-- preloader in sidebar link -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const loader = document.getElementById("loader");
      const sidebarLinks = document.querySelectorAll("#sidebar a");

      sidebarLinks.forEach(link => {
        link.addEventListener("click", () => {
          loader.classList.remove("hidden"); // Show the preloader
        });
      });
    });
  </script>

  <script>
    window.addEventListener("pageshow", function (event) {
      // Always hide the loader when coming back to this page
      const loader = document.getElementById("loader");
      if (loader) {
        loader.classList.add("hidden");
      }
    });
  </script>

  <!-- for sidebar toggle and badge clearing -->
  <!-- <script>
    $(document).ready(function () {
      $("#inbox-toggle").on("click", function (e) {
        e.preventDefault();

        const sidebar = $("#inbox-sidebar");
        const isOpen = !sidebar.hasClass("hidden");

        if (isOpen) {
          sidebar.addClass("hidden").removeClass("translate-x-0").addClass("translate-x-full");
        } else {
          sidebar.removeClass("hidden").removeClass("translate-x-full").addClass("translate-x-0");
          $("#inbox-toggle span.absolute").remove();
          $("#inbox-messages-list li").removeClass("bg-green-50");
          $("#inbox-messages-list span.text-green-600").remove();
        }
      });
    });
  </script> -->
</body>

</html>