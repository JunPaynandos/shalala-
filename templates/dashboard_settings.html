<!DOCTYPE html>
<html lang="en">

<head>
  {% load static %}
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <script src="https://cdn.tailwindcss.com"></script>
  <link href="https://cdn.jsdelivr.net/npm/bootstrap-icons/font/bootstrap-icons.css" rel="stylesheet" />
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css" />
  <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
  <title>Settings</title>
  <link rel="icon" type="image/png" href="{% static 'images/sll2.png' %}" />
  <style>
    .message-container {
      position: absolute;
      right: 10px;
      width: 20rem;
      margin-top: -5px;
      text-align: center;
    }

    .message-container .error-message {
      color: firebrick;
      font-size: 16px;
      background-color: #f8d7da;
      padding: 10px;
      border-radius: 5px;
      border: 1px solid #f5c6cb;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);

    }

    .message-container .info-message {
      background-color: #e6ffed;
      border: 1px solid #bee5eb;
      border-radius: 5px;
      color: #20a057;
      padding: 10px;
      box-shadow: 0 0 5px rgba(0, 0, 0, 0.1);
    }

    #message-container {
      transition: opacity 1s ease-out;
    }

    #workspace-button {
      transition: background-color 0.3s ease;
    }

    #workspace-button:hover {
      background-color: #d1d5db;
    }

    #workspace-button.active {
      background-color: #d1d5db;
    }

    #workspace-dropdown,
    #profile-dropdown {
      border: 1px solid #aaa;
    }

    @keyframes fade-in-down {
      0% {
        opacity: 0;
        transform: translateY(-10px);
      }

      100% {
        opacity: 1;
        transform: translateY(0);
      }
    }

    .animate-fade-in-down {
      animation: fade-in-down 0.3s ease-out;
    }

    @media (max-width: 768px) {
      #inbox-sidebar {
        max-width: 84.5% !important;
      }

      #notification-dropdown {
        position: absolute;
        right: -4rem !important;
      }

      #loader svg {
        width: 3rem;
        height: 3rem;
      }

      #sidebarBackdrop {
        display: none;
        position: fixed;
        top: 0;
        left: 0;
        right: 0;
        bottom: 0;
        z-index: 9;
      }

      #sidebarBackdrop.hidden {
        display: none;
      }

      #sidebarBackdrop:not(.hidden) {
        display: block;
      }
    }
  </style>
</head>

<body>
  <!-- Navbar -->
  <nav
    class="bg-white fixed w-full text-black flex justify-between items-center border-b border-solid border-[#aaa] p-2 pl-0 pr-0 z-10">
    <!-- left wrapper -->
    <div class="flex items-center ml-2 gap-2">
      <!-- Mobile toggle button -->
      <button id="sidebarToggle"
        class="block xl:hidden ml-auto p-2 text-gray-700 hover:text-black focus:outline-none z-30">
        <svg id="hamburgerIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16" />
        </svg>
        <svg id="closeIcon" xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 hidden" fill="none" viewBox="0 0 24 24"
          stroke="currentColor">
          <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M6 18L18 6M6 6l12 12" />
        </svg>
      </button>

      <div class="flex items-center ml-0">
        <a href="{% if user.profile.role == 'admin' %}{% url 'admin_page' %}{% else %}{% url 'workspace' %}{% endif %}">
          <img src="{% static 'images/sl.png' %}" alt="Logo" class="w-12 h-9 mr-4" />
      </div>
    </div>

    <!-- right wrapper -->
    <div class="flex items-center gap-x-4 mr-4">
      <!-- Inbox Icon -->
      <div class="relative">
        <a href="#" id="inbox-toggle" class="inbox-link relative flex text-gray-500 hover:text-[#2bdf78]">
          <i class="bi bi-envelope-fill text-xl"></i>
          {% if unread_count > 0 %}
          <span
            class="absolute top-[-6px] right-[-6px] bg-red-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center">
            {{ unread_count }}
          </span>
          {% endif %}
        </a>

        <!-- Messenger like Sidebar -->
        <div id="inbox-sidebar"
          class="hidden fixed top-0 right-0 w-96 h-screen bg-white border-l border-gray-300 shadow-lg z-50 transition-transform transform translate-x-full flex flex-col">
          <!-- sidebar preloader -->
          <div id="loader2" class="hidden fixed inset-0 flex items-center justify-center bg-opacity-70 bg-white z-50">
            <svg xmlns="http://www.w3.org/2000/svg" class="w-10 h-10" viewBox="0 0 200 200">
              <circle fill="#897F7B" stroke="#897F7B" stroke-width="15" r="15" cx="40" cy="65">
                <animate attributeName="cy" calcMode="spline" dur="2" values="65;135;65;"
                  keySplines=".5 0 .5 1;.5 0 .5 1" repeatCount="indefinite" begin="-.4"></animate>
              </circle>
              <circle fill="#897F7B" stroke="#897F7B" stroke-width="15" r="15" cx="100" cy="65">
                <animate attributeName="cy" calcMode="spline" dur="2" values="65;135;65;"
                  keySplines=".5 0 .5 1;.5 0 .5 1" repeatCount="indefinite" begin="-.2"></animate>
              </circle>
              <circle fill="#897F7B" stroke="#897F7B" stroke-width="15" r="15" cx="160" cy="65">
                <animate attributeName="cy" calcMode="spline" dur="2" values="65;135;65;"
                  keySplines=".5 0 .5 1;.5 0 .5 1" repeatCount="indefinite" begin="0"></animate>
              </circle>
            </svg>
          </div>

          <!-- Header -->
          <div class="flex items-center justify-between p-4 border-b font-semibold text-lg bg-white sticky top-0 z-10">
            <span id="chat-username">Messages</span>
            <button id="close-inbox-sidebar" class="text-gray-500 hover:text-red-500">
              <i class="fas fa-times"></i>
            </button>
          </div>

          <!-- Body that grows to fill available space -->
          <div class="flex-1 flex flex-col overflow-hidden">
            <!-- Message List -->
            <ul id="inbox-messages-list" class="overflow-y-auto flex-1 px-4 py-2">
              <!-- Conversations will load here via AJAX -->
            </ul>

            <div class="px-4 py-6 border-t bg-white text-right">
              <button id="compose-toggle-btn" class="inline-flex gap-1 text-md text-blue-600 hover:underline">Send us a
                message <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" fill="none" stroke="currentColor"
                  stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="w-[1em] h-[1em] mt-[3px] mr-1">
                  <path d="M4 22L20 12L4 2V10L16 12L4 14V22Z" />
                </svg>
              </button>
            </div>

            <div id="compose-message" class="hidden p-4 border-t bg-gray-50 mt-[-3rem] h-full">
              <label for="recipient-select"
                class="block text-md font-medium mb-2 outline-none focus:ring-[#0e9272] focus:border-[#0e9272]">Select
                Recipient</label>
              <select id="recipient-select"
                class="w-full p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-emerald-500">
                <option value="">Select someone to help</option>
              </select>

              <label for="message-content" class="block text-md font-medium mt-4 mb-2">Message</label>
              <textarea id="message-content"
                class="w-full h-[20rem] p-2 border border-gray-300 rounded-lg focus:outline-none focus:ring-1 focus:ring-emerald-500"
                rows="4" placeholder="Write your message..."></textarea>

              <div class="flex justify-end mt-4">
                <button id="send-message-btn"
                  class="bg-emerald-500 hover:bg-emerald-600 text-white py-3 px-8 rounded-lg cursor-pointer" disabled>
                  Send
                </button>
              </div>
            </div>

            <!-- Message Thread -->
            <div id="chat-thread" class="hidden flex-1 overflow-y-auto px-4 py-2 space-y-2 mt-[-3rem] bg-gray-50">
              <button onclick="backToInboxList()" class="text-sm text-blue-600 hover:underline">
                ‚Üê Back
              </button>
              <!-- Messages will be dynamically loaded here -->
              <p class="text-sm text-gray-500 text-center">
                Select a conversation
              </p>
              <div id="typing-indicator" class="text-sm text-gray-500 italic px-4 py-1 hidden">
                Typing...
              </div>
            </div>

            <!-- Message Input -->
            <form id="chat-form" class="hidden p-3 border-t flex items-center sticky bottom-0 z-100 bg-white gap-2">
              {% csrf_token %}
              <textarea id="chat-input" placeholder="Type a message..."
                class="flex-1 border border-gray-300 rounded-lg px-4 py-2 focus:outline-none focus:ring-2 focus:ring-emerald-500 resize-none overflow-y-scroll h-14 max-h-24 leading-snug text-md hide-scrollbar"
                rows="1" style="white-space: pre-wrap; overflow-wrap: break-word;"></textarea>
              <button type="submit"
                class="bg-emerald-500 hover:bg-emerald-600 text-white px-4 py-4 rounded-lg focus:outline-none focus:ring-2 focus:ring-emerald-500">
                Send
              </button>
            </form>
          </div>
        </div>
      </div>

      <!-- Notification Bell -->
      <div class="relative">
        <button id="bell-button" class="relative flex text-gray-500 hover:text-[#2bdf78] mr-[-12px]">
          <i class="bi bi-bell-fill text-xl"></i>
          <span id="pending-badge"
            class="absolute top-[-5px] right-[5px] bg-red-500 text-white text-xs w-5 h-5 rounded-full flex items-center justify-center hidden">
            0
          </span>
        </button>

        <!-- Dropdown -->
        <div id="notification-dropdown"
          class="absolute right-[-20px] mt-2 w-72 bg-white border border-gray-400 rounded shadow-lg hidden">
          <div class="p-4 border-b text-sm font-semibold text-gray-700">
            Notifications
          </div>
          <ul id="notification-list" class="max-h-60 overflow-y-auto text-sm divide-y divide-gray-100">
            <li class="p-4 text-gray-500 text-center">Loading...</li>
          </ul>

        </div>
      </div>

      <!-- Profile Chip with Dropdown -->
      <div class="relative">
        <div class="flex items-center space-x-2 text-white p-2 rounded-full cursor-pointer" id="profile-button">
          <!-- Avatar -->
          <div class="w-8 h-8 rounded-full overflow-hidden border-2 border-gray-300">
            {% with request.user.profile as my_profile %}
            {% if my_profile.get_profile_image %}
            <img src="{{ my_profile.get_profile_image }}" alt="User Avatar" class="w-full h-full object-cover" />
            {% else %}
            <span class="...">
              {{ request.user.first_name|slice:":1"|upper }}{{
              request.user.last_name|slice:":1"|upper }}
            </span>
            {% endif %}
            {% endwith %}
          </div>
        </div>

        <!-- Dropdown Menu -->
        <div id="profile-dropdown"
          class="absolute right-[-8px] md:right-0 hidden bg-white text-black rounded shadow-md w-48 z-10 p-1 mr-2">
          <ul class="py-2">
            <li class="px-4 py-2 text-m text-black-600">
              <strong>{{ user.first_name }}</strong> <br />
              <span class="text-sm text-gray-500 truncate" style="max-width: 150px; display: inline-block">
                {{ user.email }}
              </span>
            </li>
            <li>
              <a href="{% url 'account_settings' %}?next={{ request.path }}"
                class="block px-4 py-2 hover:bg-gray-200">Account settings</a>
            </li>
            <li>
              <a href="{% url 'logout' %}" class="block px-4 py-2 hover:bg-gray-200">Log Out</a>
            </li>
          </ul>
        </div>
      </div>
    </div>

  </nav>

  <div class="flex flex-1">
    <div id="sidebarBackdrop" class="fixed inset-0 hidden z-10"></div>
    <!-- Sidebar -->
    <div id="sidebar"
      class="bg-white text-black w-14 min-h-screen fixed mt-[4.08rem] p-4 transform -translate-x-full md:translate-x-0 transition-all duration-300 ease-in-out md:hover:w-52 group border-r border-solid border-[#aaa] group-hover:bg-white z-10">
      <nav>
        <ul>
          <li class="mt-2 mb-2 relative flex items-center space-x-4 text-black group cursor-pointer">
            <a href="{% if user.profile.role == 'admin' %}{% url 'admin_workspace' %}{% else %}{% url 'workspace' %}{% endif %}"
              class="ml-[-6px] px-2 py-2 flex items-center w-full min-w-[2.2rem] space-x-2 rounded hover:bg-gray-200">
              <div class="flex-shrink-0">
                <img src="{% static 'images/layers.png' %}" alt="" width="18" height="18" />
              </div>
              <span
                class="absolute left-4 pointer-events-none md:pointer-events-auto opacity-0 md:group-hover:opacity-100 transition-all">
                Workspace
              </span>
            </a>
          </li>
          <li class="mt-2 mb-2 relative flex items-center space-x-4 text-black group cursor-pointer">
            <a href="{% if user.profile.role == 'admin' %}{% url 'admin_dashboard' %}{% else %}{% url 'dashboard' %}{% endif %}"
              class="ml-[-6px] px-2 py-2 flex items-center w-full min-w-[2.2rem] space-x-2 rounded hover:bg-gray-200">
              <div class="flex-shrink-0">
                <img src="{% static 'images/dashboard.png' %}" alt="" width="18" height="18" />
              </div>
              <span
                class="absolute left-4 pointer-events-none md:pointer-events-auto opacity-0 md:group-hover:opacity-100 transition-all">
                Dashboard
              </span>
            </a>
          </li>
          <li class="mt-2 mb-2 relative flex items-center space-x-4 text-black group cursor-pointer">
            <a href="{% url 'crop_details' %}"
              class="ml-[-6px] px-2 py-2 flex items-center w-full min-w-[2.2rem] space-x-2 rounded hover:bg-gray-200">
              <div class="flex-shrink-0">
                <img src="{% static 'images/info.png' %}" alt="" width="18" height="18" />
              </div>
              <span
                class="absolute left-4 pointer-events-none md:pointer-events-auto opacity-0 md:group-hover:opacity-100 transition-all">
                Crop_list
              </span>
            </a>
          </li>
          <li class="mt-2 mb-2 relative flex items-center space-x-4 text-black group cursor-pointer">
            <a href="{% url 'reports' %}"
              class="ml-[-6px] px-2 py-2 flex items-center w-full min-w-[2.2rem] space-x-2 rounded hover:bg-gray-200">
              <div class="flex-shrink-0">
                <img src="{% static 'images/bar-chart.png' %}" alt="" width="18" height="18" />
              </div>
              <span
                class="absolute left-4 pointer-events-none md:pointer-events-auto opacity-0 md:group-hover:opacity-100 transition-all">Reports
              </span>
            </a>
          </li>
          <li class="mt-2 mb-2 relative flex items-center space-x-4 text-black group cursor-pointer">
            <a href="{% url 'dashboard_settings' %}"
              class="ml-[-6px] px-2 py-2 flex items-center w-full min-w-[2.2rem] hover:bg-gray-200 rounded space-x-2 active-link {% if request.resolver_match.url_name == 'dashboard_settings' %} bg-gray-200 text-gray-800 font-semibold {% endif %}">
              <div class="flex-shrink-0">
                <img src="{% static 'images/settings.png' %}" alt="" width="18" height="18" />
              </div>
              <span
                class="absolute left-4 pointer-events-none md:pointer-events-auto opacity-0 md:group-hover:opacity-100 transition-all">Settings
              </span>
            </a>
          </li>
        </ul>
      </nav>
    </div>

    <!-- Main Content -->
    <div class="flex-1 p-6 mt-16 md:ml-[4rem] group-hover:ml-52 transition-all duration-300 ease-in-out">

      {% if messages %}
      <div class="message-container" id="message-container">
        {% for message in messages %} {% if message.tags == 'error' %}
        <div class="error-message">
          <h4>{{ message }}</h4>
        </div>
        {% else %}
        <div class="info-message">
          <h4>{{ message }}</h4>
        </div>
        {% endif %} {% endfor %}
      </div>
      {% endif %}

      <h1 class="text-3xl font-bold mb-8 sm:text-2xl xs:text-xl text-center sm:text-left">
        Workspace Settings
      </h1>
      <div class="flex-1 space-y-10">
        <!-- Workspace Edit Section -->
        <div data-id="name" class="scroll-mt-24 xl:scroll-mt-20">
          <div id="workspace-name"
            class="p-6 md:p-8 page-primary border border-solid border-primary scroll-mt-20 rounded-md">
            <div class="mb-8 md:ml-8 md:mr-8">
              <div class="flex justify-between flex-col small:flex-row gap-y-6">
                <div class="flex small:pr-4 justify-between">
                  <h4 class="text-strong type-heading-03 font-semibold text-lg">
                    Workspace Name
                  </h4>
                  <div id="edit-trigger" class="ml-4">
                    <button type="button" id="edit-btn"
                      class="type-interface-00 rounded button-secondary-text hover:bg-[#14d2a3] hover:text-white active:bg-[#14d2a3] active:text-white border border-solid button-secondary-border h-8 py-1.5 px-2 focus-visible:outline focus-visible:outline-focus-action outline-offset-2 outline-2 flex items-center group/button">
                      <div class="inline-flex w-4 h-4 me-1.5">
                        <svg fill="currentColor" width="16" height="16" viewBox="0 0 16 16">
                          <path d="M15 13H1V14H15V13Z"></path>
                          <path
                            d="M12.7 4.5C13.1 4.1 13.1 3.5 12.7 3.1L10.9 1.3C10.5 0.9 9.9 0.9 9.5 1.3L2 8.8V12H5.2L12.7 4.5ZM10.2 2L12 3.8L10.5 5.3L8.7 3.5L10.2 2ZM3 11V9.2L8 4.2L9.8 6L4.8 11H3Z">
                          </path>
                        </svg>
                      </div>
                      Edit
                    </button>
                  </div>
                </div>
                <div class="type-body-02 text-secondary mt-[-20px] max-w-xl font-sm text-gray-400">
                  A unique name for your workspace
                </div>
              </div>
            </div>

            <!-- Form Section -->
            <div class="type-body-02 text-primary md:ml-8 md:mr-8">
              <form method="POST" action="{% url 'update_workspace' %}" novalidate>
                {% csrf_token %}
                <div class="mt-[-20px]">
                  <label for="edit-workspace-name-field" class="sr-only">Workspace name</label>
                  <div class="flex flex-col">
                    <div class="flex relative">
                      <input type="hidden" name="workspace" value="{{ selected_workspace.id }}" />
                      <input id="edit-workspace-name-field" name="name" type="text"
                        class="h-10 truncate type-interface-01 w-full m-0 py-2.5 px-3 placeholder:input-text--placeholder focus-visible:outline focus:outline-focus-action outline-none border border-gray-300 rounded appearance-none input-border input-background input-text bg-gray-200 focus:ring-[#0e9272] focus:border-[#0e9272]"
                        value="{{ selected_workspace.name }}" placeholder="Workspace name" autocomplete="off"
                        readonly />
                    </div>
                  </div>
                </div>

                <div class="mt-4">
                  <label for="workspace-description" class="block font-semibold text-lg">Description</label>
                  <textarea id="workspace-description" name="description"
                    class="mt-1 p-2 h-48 border border-gray-300 bg-gray-200 w-full rounded outline-none focus:outline focus:outline-focus-action focus:ring-[#0e9272] focus:border-[#0e9272]"
                    placeholder="Workspace description" readonly>
{{ selected_workspace.description }}</textarea>
                </div>

                <!-- Save & Cancel Buttons -->
                <div id="action-buttons" class="mt-4 flex justify-end gap-4 hidden">
                  <button type="button" id="cancel-btn"
                    class="type-interface-01 button-secondary-text hover:button-secondary-background--hover hover:button-secondary-text--hover active:button-secondary-background--active active:button-secondary-text--hover--active hover:bg-gray-300 border border-solid button-secondary-border py-2.5 px-4 rounded">
                    Cancel
                  </button>
                  <button type="submit"
                    class="button-primary-background hover:button-primary-background--hover hover:button-primary-text--hover active:button-primary-background--active active:button-primary-text--active py-2.5 px-4 type-interface-01 rounded bg-gray-200 transition-colors"
                    id="save-btn">
                    Save Changes
                  </button>
                </div>
              </form>
            </div>
          </div>
        </div>

        <!-- Workspace Delete Section -->
        <div data-id="delete-project" class="scroll-mt-24 xl:scroll-mt-20">
          <div id="workspace-deletion"
            class="p-6 md:p-8 page-primary border border-solid border-primary scroll-mt-20 rounded-md">
            <div class="mb-8 md:ml-8 md:mr-8">
              <div class="flex justify-between">
                <div class="flex-1 small:pr-4">
                  <div>
                    <h4 class="text-strong type-heading-03 text-lg font-semibold">
                      Workspace Deletion
                    </h4>
                  </div>
                  <div class="type-body-02 text-gray-500 mt-1">
                    The workspace, including all associated data, will be
                    permanently deleted. This action cannot be undone.
                  </div>
                </div>
              </div>
            </div>

            <!-- Delete Button -->
            <div class="type-body-02 text-primary md:ml-8">
              <button type="button" id="delete-btn"
                class="type-interface-01 h-10 py-2.5 px-3 focus-visible:outline focus-visible:outline-focus-action outline-offset-2 outline-2 flex items-center group/button rounded bg-red-400 hover:bg-red-800 text-white hover:text-white">
                <div class="inline-flex w-4 h-4 me-1.5">
                  <svg fill="currentColor" width="16" height="17" viewBox="0 0 16 17"
                    xmlns="http://www.w3.org/2000/svg">
                    <path d="M7 6.66699H6V12.667H7V6.66699Z"></path>
                    <path d="M10 6.66699H9V12.667H10V6.66699Z"></path>
                    <path
                      d="M2 3.66699V4.66699H3V14.667C3 14.9322 3.10536 15.1866 3.29289 15.3741C3.48043 15.5616 3.73478 15.667 4 15.667H12C12.2652 15.667 12.5196 15.5616 12.7071 15.3741C12.8946 15.1866 13 14.9322 13 14.667V4.66699H14V3.66699H2ZM4 14.667V4.66699H12V14.667H4Z">
                    </path>
                    <path d="M10 1.66699H6V2.66699H10V1.66699Z"></path>
                  </svg>
                </div>
                Delete Workspace
              </button>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>

  <!-- modal -->
  <div id="confirmation-modal"
    class="hidden fixed inset-0 bg-gray-500 bg-opacity-75 flex items-center justify-center z-50 px-4 sm:px-8">
    <div class="bg-white p-6 rounded-md shadow-lg w-full sm:w-1/3 md:w-1/2 xl:w-1/3">
      <h4 class=" text-lg sm:text-xl font-semibold mb-4 text-center sm:text-left">
        Are you sure you want to delete this workspace?
      </h4>
      <p class="mb-6 text-gray-600 text-center sm:text-left">
        This action cannot be undone.
      </p>
      <form action="{% url 'delete_workspace' %}" method="POST">
        {% csrf_token %}
        <input type="hidden" name="workspace" value="{{ selected_workspace.id }}" />
        <div class="flex flex-col sm:flex-row justify-end gap-4">
          <button type="button" id="close-modal-btn"
            class="bg-gray-300 py-2 px-4 rounded-md text-gray-700 w-full sm:w-auto">
            Cancel
          </button>
          <button type="submit" class="bg-red-500 text-white py-2 px-4 rounded-md w-full sm:w-auto">
            Delete
          </button>
        </div>
      </form>
    </div>
  </div>


  <!-- Preloader -->
  <div id="loader" class="hidden fixed inset-0 flex items-center justify-center bg-opacity-70 bg-white z-50">
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 200 200" class="w-20 h-20 animate-spin">
      <radialGradient id="a9" cx=".66" fx=".66" cy=".3125" fy=".3125" gradientTransform="scale(1.5)">
        <stop offset="0" stop-color="#888"></stop>
        <stop offset=".3" stop-color="#888" stop-opacity=".9"></stop>
        <stop offset=".6" stop-color="#888" stop-opacity=".6"></stop>
        <stop offset=".8" stop-color="#888" stop-opacity=".3"></stop>
        <stop offset="1" stop-color="#888" stop-opacity="0"></stop>
      </radialGradient>
      <circle transform-origin="center" fill="none" stroke="url(#a9)" stroke-width="30" stroke-linecap="round"
        stroke-dasharray="200 1000" stroke-dashoffset="0" cx="100" cy="100" r="70">
        <animateTransform type="rotate" attributeName="transform" calcMode="spline" dur="2" values="360;0"
          keyTimes="0;1" keySplines="0 0 1 1" repeatCount="indefinite"></animateTransform>
      </circle>
      <circle transform-origin="center" fill="none" opacity=".2" stroke="#888" stroke-width="30" stroke-linecap="round"
        cx="100" cy="100" r="70"></circle>
    </svg>
  </div>

  <script>
    document.addEventListener("DOMContentLoaded", function () {
      const profileButton = document.getElementById("profile-button");
      const profileDropdown = document.getElementById("profile-dropdown");
      // const workspaceButton = document.getElementById("workspace-button");
      // const workspaceDropdown = document.getElementById("workspace-dropdown");
      const inboxToggle = document.getElementById("inbox-toggle");
      const inboxDropdown = document.getElementById("inbox-dropdown");
      const inboxSidebar = document.getElementById("inbox-sidebar");
      const loader = document.getElementById("loader");
      const sidebarLinks = document.querySelectorAll("#sidebar a");
      const composeMessageDiv = document.getElementById("compose-message");
      const recipientSelect = document.getElementById("recipient-select");
      const messageContent = document.getElementById("message-content");
      const sendMessageBtn = document.getElementById("send-message-btn");
      const composeBtn = document.getElementById("compose-toggle-btn");
      const bellButton = document.getElementById("bell-button");
      const bellDropdown = document.getElementById("notification-dropdown");

      let currentChatUserId = null;

      // Scroll to bottom of chat
      function scrollToBottom() {
        const chatThread = document.getElementById("chat-thread");
        if (chatThread) {
          chatThread.scrollTop = chatThread.scrollHeight;
        }
      }

      // Dropdown setup functions
      function hideAllDropdowns() {
        profileDropdown.classList.add("hidden");
        // workspaceDropdown.classList.add("hidden");
        bellDropdown.classList.add("hidden");
        if (inboxDropdown) inboxDropdown.classList.add("hidden");
      }

      function setupDropdown(button, dropdown, onOpenCallback) {
        if (!button || !dropdown) return;
        button.addEventListener("click", function (e) {
          e.stopPropagation();
          const isHidden = dropdown.classList.contains("hidden");
          hideAllDropdowns();
          if (isHidden) {
            // Apply the animation and make dropdown visible
            dropdown.classList.remove("hidden");
            dropdown.classList.add("animate-fade-in-down");
            setTimeout(
              () => dropdown.classList.remove("animate-fade-in-down"),
              300
            ); // Remove animation class after 300ms
          }
          if (typeof onOpenCallback === "function") {
            onOpenCallback();
          }
        });
      }

      // setupDropdown(workspaceButton, workspaceDropdown);
      setupDropdown(profileButton, profileDropdown);
      // setupDropdown(bellButton, bellDropdown, fetchPendingAccounts);
      setupDropdown(bellButton, bellDropdown);
      if (inboxToggle && inboxDropdown) {
        setupDropdown(inboxToggle, inboxDropdown);
      }

      document.addEventListener("click", function (e) {
        if (
          !profileButton.contains(e.target) &&
          !profileDropdown.contains(e.target) &&
          !bellButton?.contains(e.target) &&
          !bellDropdown?.contains(e.target) &&
          (!inboxToggle || !inboxToggle.contains(e.target)) &&
          (!inboxDropdown || !inboxDropdown.contains(e.target))
        ) {
          hideAllDropdowns();
        }
      });

      if (loader) {
        sidebarLinks.forEach((link) => {
          link.addEventListener("click", () => {
            loader.classList.remove("hidden");
          });
        });

        window.addEventListener("pageshow", () => {
          loader.classList.add("hidden");
        });
      }

      updateInboxDropdown();

      if (inboxToggle && inboxSidebar) {
        inboxToggle.addEventListener("click", function (e) {
          e.preventDefault();
          updateInboxDropdown();
          inboxSidebar.classList.remove("hidden", "translate-x-full");
        });
      }

      const closeBtn = document.getElementById("close-inbox-sidebar");
      if (closeBtn) {
        closeBtn.addEventListener("click", function () {
          inboxSidebar.classList.add("translate-x-full");
          setTimeout(() => {
            inboxSidebar.classList.add("hidden");
          }, 300);
        });
      }

      function updateInboxDropdown() {
        $.ajax({
          url: "{% url 'ajax_messages_status' %}",
          method: "GET",
          success: function (data) {
            const badge = $("#inbox-toggle span");
            const count = data.unread_count;

            if (count > 0) {
              if (badge.length > 0) {
                badge.text(count);
              } else {
                $("#inbox-toggle").append(`
                    <span class="absolute top-[-6px] right-[-6px] bg-red-500 text-white text-[10px] font-bold rounded-full w-5 h-5 flex items-center justify-center">
                      ${count}
                    </span>
                  `);
              }
            } else {
              badge.remove();
            }

            const inboxList = $("#inbox-messages-list");
            inboxList.empty();

            if (data.messages.length > 0) {
              const uniqueSenders = {};

              // Loop through messages to collect the latest message per sender
              data.messages.forEach((msg) => {
                if (!uniqueSenders[msg.sender_id]) {
                  uniqueSenders[msg.sender_id] = msg;
                }
              });

              Object.values(uniqueSenders).forEach((msg) => {
                inboxList.append(`
                    <li class="p-2 border-b hover:bg-gray-100 cursor-pointer flex items-start space-x-2 rounded ${msg.is_read ? "bg-white" : "bg-green-50"
                  }"
                        onclick="openMessage(${msg.sender_id}, '${msg.sender
                  }')">
                      <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 border border-gray-300 bg-gray-200 flex items-center justify-center text-sm font-semibold text-white">
                        ${msg.sender_avatar
                    ? `<img src="${msg.sender_avatar}" alt="Avatar" class="w-full h-full object-cover">`
                    : `<span class="bg-gray-500 w-full h-full flex items-center justify-center">${msg.sender_initials}</span>`
                  }
                      </div>
                      <div class="flex flex-col w-full truncate text-ellipsis">
                        <div class="flex justify-between items-center">
                          <strong class="${msg.is_read
                    ? "text-gray-600"
                    : "text-black font-semibold"
                  }">${msg.sender}</strong>
                          ${msg.is_read
                    ? ""
                    : '<span class="text-xs text-green-600 font-semibold">‚Ä¢ New</span>'
                  }
                        </div>
                        <div class="text-sm text-gray-600 whitespace-nowrap overflow-hidden w-full truncate text-ellipsis">${msg.content
                  }</div>
                        <small class="text-xs text-gray-400">${msg.timestamp
                  }</small>
                      </div>
                    </li>
                  `);
              });
              // If the sidebar is open, clear badge + "New" highlights
              if (!$("#inbox-sidebar").hasClass("hidden")) {
                $("#inbox-toggle span.absolute").remove();
                inboxList.find("li").removeClass("bg-green-50");
                inboxList.find("span.text-green-600").remove();
              }
            } else {
              inboxList.html(
                '<p class="flex flex-col items-center justify-center h-full min-h-[200px] text-center text-lg text-gray-500 p-3">No messages<br><span class="text-sm mt-1">Messages from the team will be shown here</span></p>'
              );
            }
          },
          error: function () {
            console.error("Failed to fetch messages");
          },
        });
      }

      window.openMessage = function (senderId, username) {
        currentChatUserId = senderId;
        $("#inbox-messages-list").addClass("hidden");
        $("#chat-thread").removeClass("hidden").empty();
        $("#chat-form").removeClass("hidden");
        $("#compose-toggle-btn").addClass("hidden");
        $("#chat-username").html(`
            <button onclick="backToInboxList()" class="text-sm text-blue-600 hover:underline mr-2">‚Üê Back</button>
            ${username}
          `);

        // Mark messages as read
        fetch(`/messages/mark_read/${senderId}/`)
          .then((response) => response.json())
          .then((data) => {
            if (data.status === "ok") {
              // Refresh the dropdown to update UI (badge, background, dot)
              updateInboxDropdown();
            }
          });

        loadConversation(senderId);
      };

      window.backToInboxList = function () {
        currentChatUserId = null;
        $("#chat-thread").addClass("hidden").empty();
        $("#chat-form").addClass("hidden");
        $("#compose-message").addClass("hidden");
        $("#inbox-messages-list").removeClass("hidden");
        $("#chat-username").text("Messages");
        $("#compose-toggle-btn").removeClass("hidden");
      };

      function loadConversation(senderId) {
        const chatThread = $("#chat-thread");

        // Show preloader before loading content
        $("#loader2").removeClass("hidden");

        // Optional: clear chat thread for better transition
        chatThread.empty();

        // MutationObserver will monitor chatThread
        const observer = new MutationObserver((mutationsList, observer) => {
          if (chatThread.children().length > 0) {
            // Content added, hide the preloader
            $("#loader2").addClass("hidden");
            observer.disconnect(); // Stop observing
          }
        });

        // Start observing for child changes
        observer.observe(chatThread[0], { childList: true });

        $.ajax({
          url: `/messages/thread/${senderId}/`,
          method: "GET",
          success: function (data) {
            const chatThread = $("#chat-thread");
            chatThread.empty();

            if (data.messages && data.messages.length > 0) {
              data.messages.forEach((msg) => {
                const isCurrentUser = msg.sender_id == currentUserId;

                if (isCurrentUser) {
                  // Your message on the right
                  chatThread.append(`
                      <div class="flex justify-end">
                        <div class="max-w-[70%] rounded-lg px-4 py-2 my-1 bg-emerald-500 text-white" style="word-wrap: break-word; overflow-wrap: break-word;">
                          <span style="overflow-wrap:anywhere; white-space:pre-wrap; display:block; width:100%;">${msg.content}</span>
                          <div class="text-xs text-right opacity-70 mt-1">${msg.timestamp}</div>
                        </div>
                      </div>
                    `);
                } else {
                  // Other user's message on the left
                  const avatar = msg.sender_avatar
                    ? `<img src="${msg.sender_avatar}" alt="Avatar" class="w-full h-full object-cover">`
                    : `<div class="bg-gray-400 text-white w-full h-full flex items-center justify-center text-xs font-semibold rounded-full">üë§</div>`;

                  chatThread.append(`
                      <div class="flex items-start space-x-2 my-2">
                        <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 border border-gray-300">
                          ${avatar}
                        </div>
                        <div class="bg-gray-200 text-black max-w-[70%] px-4 py-2 rounded-lg" style="word-wrap: break-word; overflow-wrap: break-word;">
                          <span style="overflow-wrap:anywhere; white-space:pre-wrap; display:block; width:100%;">${msg.content}</span>
                          <div class="text-xs text-right opacity-70 mt-1">${msg.timestamp}</div>
                        </div>
                      </div>
                    `);
                }
              });
            } else {
              chatThread.html(
                '<p class="text-sm text-gray-500 text-center">No messages in this thread.</p>'
              );
              $("#loader").addClass("hidden"); // Still hide loader on failure
              observer.disconnect();
            }

            scrollToBottom();
          },
          error: function () {
            console.error("Failed to load conversation.");
            $("#chat-thread").html(
              '<p class="text-sm text-red-500 text-center">Could not load messages.</p>'
            );
          },
        });
      }

      const inboxSocket = new WebSocket(
        // "ws://" + window.location.host + "/ws/inbox/"
        (window.location.protocol === "https:" ? "wss://" : "ws://") + window.location.host + "/ws/inbox/"
      );
      inboxSocket.onmessage = function (e) {
        const data = JSON.parse(e.data);
        if (data.type === "new_message") {
          // if (!currentUserId) {
          //   updateInboxDropdown();
          // }

          updateInboxDropdown();

          const msg = data.message;
          if (
            // currentChatUserId &&
            // parseInt(currentChatUserId) === msg.sender_id

            currentChatUserId &&
            (parseInt(currentChatUserId) === msg.sender_id ||
              parseInt(currentChatUserId) === msg.recipient_id)
          ) {
            const isCurrentUser = msg.sender_id == currentUserId;

            if (isCurrentUser) {
              $("#chat-thread").append(`
                  <div class="flex justify-end">
                    <div class="max-w-[70%] rounded-lg px-4 py-2 my-1 bg-emerald-500 text-white" style="word-wrap: break-word; overflow-wrap: break-word;">
                      <span style="word-wrap: break-word; overflow-wrap: break-word;">${msg.content}</span>
                      <div class="text-xs text-right opacity-70 mt-1">${msg.timestamp}</div>
                    </div>
                  </div>
                `);
            } else {
              const avatar = msg.sender_avatar
                ? `<img src="${msg.sender_avatar}" alt="Avatar" class="w-full h-full object-cover">`
                : `<div class="bg-gray-400 text-white w-full h-full flex items-center justify-center text-xs font-semibold rounded-full">üë§</div>`;
              console.log("Avatar URL: ", msg.sender_avatar);
              $("#chat-thread").append(`
                  <div class="flex items-start space-x-2 my-2">
                    <div class="w-8 h-8 rounded-full overflow-hidden flex-shrink-0 border border-gray-300">
                      ${avatar}
                    </div>
                    <div class="bg-gray-200 text-black max-w-[70%] px-4 py-2 rounded-lg" style="word-wrap: break-word; overflow-wrap: break-word;">
                      <span style="word-wrap: break-word; overflow-wrap: break-word;">${msg.content}</span>
                      <div class="text-xs text-right opacity-70 mt-1">${msg.timestamp}</div>
                    </div>
                  </div>
                `);
            }

            // $('#chat-thread').scrollTop($('#chat-thread')[0].scrollHeight);
            scrollToBottom();
          } else {
            // If not in that thread, update inbox preview
            updateInboxDropdown();
          }
        }
      };

      inboxSocket.onopen = function () {
        console.log("WebSocket connected");
      };

      inboxSocket.onclose = function () {
        console.warn("WebSocket closed unexpectedly");
      };

      // SEND MESSAGE HANDLER
      const chatForm = document.getElementById("chat-form");
      const chatInput = document.getElementById("chat-input");

      function getCSRFToken() {
        // return document.querySelector('[name=csrfmiddlewaretoken]')?.value;
        const csrfTokenElement = document.querySelector(
          "[name=csrfmiddlewaretoken]"
        );
        return csrfTokenElement ? csrfTokenElement.value : "";
      }

      if (chatForm) {
        chatForm.addEventListener("submit", function (e) {
          e.preventDefault();
          const message = chatInput.value.trim();
          if (!message || !currentChatUserId) return;

          // Ensure CSRF token is correctly attached
          const csrfToken = getCSRFToken(); // Get the CSRF token
          if (!csrfToken) {
            console.error("CSRF token missing");
            return; // Don't proceed without CSRF token
          }

          fetch(`/messages/send/${currentChatUserId}/`, {
            method: "POST",
            headers: {
              "X-CSRFToken": csrfToken,
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: `message=${encodeURIComponent(message)}`,
          })
            .then((response) => response.json())
            .then((data) => {
              if (data.status === "ok") {
                $("#chat-thread").append(`
                  <div class="flex justify-end">
                    <div class="max-w-[70%] rounded-lg px-4 py-2 my-1 bg-emerald-500 text-white" style="word-wrap: break-word; overflow-wrap: break-word;">
                      <span style="word-wrap: break-word; overflow-wrap: break-word;">${message}</span>
                      <div class="text-xs text-right opacity-70 mt-1">${new Date().toLocaleTimeString(
                  [],
                  { hour: "2-digit", minute: "2-digit" }
                )}</div>
                    </div>
                  </div>
                `);
                chatInput.value = "";
                // $('#chat-thread').scrollTop($('#chat-thread')[0].scrollHeight);
                scrollToBottom();
              } else {
                alert("Failed to send message");
              }
            })
            .catch((err) => {
              console.error("Send failed", err);
            });
        });
      }

      composeBtn.addEventListener("click", function () {
        // Hide inbox list and thread
        document.getElementById("inbox-messages-list").classList.add("hidden");
        document.getElementById("chat-thread").classList.add("hidden");
        document.getElementById("chat-form").classList.add("hidden");
        document.getElementById("compose-toggle-btn").classList.add("hidden");

        // Show compose form
        composeMessageDiv.classList.remove("hidden");

        // Reset form
        recipientSelect.value = "";
        messageContent.value = "";
        sendMessageBtn.disabled = true;

        // Optional: update header
        document.getElementById("chat-username").innerHTML = `
            <button onclick="backToInboxList()" class="text-sm text-blue-600 hover:underline mr-2">‚Üê </button>
            Compose New Message
          `;
      });

      // Fetch admin users to populate the recipient select dropdown
      function loadAdminUsers() {
        fetch('/get_admin_users/')  // URL for the new view
          .then(response => response.json())
          .then(data => {
            const admins = data.admins;
            recipientSelect.innerHTML = '<option value="">Select one of our team to help</option>';  // Reset dropdown

            admins.forEach(admin => {
              recipientSelect.innerHTML += `<option value="${admin.id}">${admin.username}</option>`;
            });
          })
          .catch(error => console.error("Error loading admin users:", error));
      }

      // Enable the send button if both recipient and message content are provided
      function checkFormValidity() {
        const recipientId = recipientSelect.value;
        const message = messageContent.value.trim();
        sendMessageBtn.disabled = !(recipientId && message);
      }

      // Listen for changes in the recipient or message content
      recipientSelect.addEventListener("change", checkFormValidity);
      messageContent.addEventListener("input", checkFormValidity);

      // Send the message when the button is clicked
      sendMessageBtn.addEventListener("click", function () {
        const recipientId = recipientSelect.value;
        const message = messageContent.value.trim();

        if (recipientId && message) {
          const csrfToken = getCSRFToken();  // Ensure CSRF token is attached

          fetch(`/messages/send/${recipientId}/`, {
            method: 'POST',
            headers: {
              'X-CSRFToken': csrfToken,
              'Content-Type': 'application/x-www-form-urlencoded',
            },
            body: `message=${encodeURIComponent(message)}`
          })
            .then(response => response.json())
            .then(data => {
              if (data.status === 'ok') {
                const recipientId = data.recipient_id || recipientSelect.value;
                const recipientUsername = recipientSelect.options[recipientSelect.selectedIndex].text;

                // Hide compose, show thread
                composeMessageDiv.classList.add("hidden");
                $('#inbox-messages-list').addClass('hidden');
                $('#chat-thread').removeClass('hidden').empty();
                $('#chat-form').removeClass('hidden');

                // Set current chat state
                currentChatUserId = recipientId;
                $('#chat-username').html(`
            <button onclick="backToInboxList()" class="text-sm text-blue-600 hover:underline mr-2">‚Üê Back</button>
            ${recipientUsername}
          `);

                // Load the conversation
                loadConversation(recipientId);
              } else {
                alert('Failed to send message');
              }
            })
            .catch(err => {
              console.error('Send failed', err);
            });
        }
      });

      // Load admin users when the page is loaded
      loadAdminUsers();
    });
  </script>

  <!-- for sidebar toggle and badge clearing -->
  <script>
    $(document).ready(function () {
      $("#inbox-toggle").on("click", function (e) {
        e.preventDefault();

        const sidebar = $("#inbox-sidebar");
        const isOpen = !sidebar.hasClass("hidden");

        if (isOpen) {
          sidebar.addClass("hidden").removeClass("translate-x-0").addClass("translate-x-full");
        } else {
          sidebar.removeClass("hidden").removeClass("translate-x-full").addClass("translate-x-0");
          $("#inbox-toggle span.absolute").remove();
          $("#inbox-messages-list li").removeClass("bg-green-50");
          $("#inbox-messages-list span.text-green-600").remove();
        }
      });
    });
  </script>

  <!-- button styles -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const nameInput = document.getElementById("edit-workspace-name-field");
      const descTextarea = document.getElementById("workspace-description");
      const saveBtn = document.getElementById("save-btn");
      const cancelBtn = document.getElementById("cancel-btn");
      const editButton = document.getElementById("edit-btn"); // Assuming you have an "Edit" button

      // Save initial values to check for changes later
      const originalName = nameInput.value.trim();
      const originalDesc = descTextarea.value.trim();

      // Function to handle input field changes
      function checkForChanges() {
        const isChanged =
          nameInput.value.trim() !== originalName ||
          descTextarea.value.trim() !== originalDesc;

        // Enable or disable Save button based on changes
        if (isChanged) {
          saveBtn.classList.add("bg-[#14d2a3]", "text-white");
          saveBtn.classList.remove("bg-gray-200", "text-gray-500");
          saveBtn.disabled = false; // Enable Save button
        } else {
          saveBtn.classList.remove("bg-[#14d2a3]", "text-white");
          saveBtn.classList.add("bg-gray-200", "text-white");
          saveBtn.disabled = true; // Disable Save button
        }
      }

      // Event listeners for input change
      nameInput.addEventListener("input", checkForChanges);
      descTextarea.addEventListener("input", checkForChanges);

      // Edit button click functionality
      editButton.addEventListener("click", () => {
        // Enable the inputs and change their background color to white
        nameInput.removeAttribute("readonly");
        descTextarea.removeAttribute("readonly");
        nameInput.classList.add("bg-white");
        descTextarea.classList.add("bg-white");

        // Reset the Save button to disabled when Edit is clicked
        saveBtn.disabled = true;
        saveBtn.classList.remove("bg-[#14d2a3]", "text-white");
        saveBtn.classList.add("bg-gray-200", "text-gray-500");
      });

      // Cancel button click functionality
      cancelBtn.addEventListener("click", () => {
        // Reset input fields to original values and background color to gray
        nameInput.value = originalName;
        descTextarea.value = originalDesc;
        nameInput.classList.remove("bg-white");
        descTextarea.classList.remove("bg-white");
        nameInput.classList.add("bg-gray-200");
        descTextarea.classList.add("bg-gray-200");

        // Revert the inputs to readonly state
        nameInput.setAttribute("readonly", true);
        descTextarea.setAttribute("readonly", true);

        // Reset the Save button to disabled
        saveBtn.disabled = true;
        saveBtn.classList.remove("bg-[#14d2a3]", "text-white");
        saveBtn.classList.add("bg-gray-200", "text-gray-500");
      });
    });
  </script>

  <!-- for modal -->
  <script>
    const deleteBtn = document.getElementById("delete-btn");
    const modal = document.getElementById("confirmation-modal");
    const closeModalBtn = document.getElementById("close-modal-btn");

    deleteBtn.addEventListener("click", () => {
      modal.classList.remove("hidden");
    });

    closeModalBtn.addEventListener("click", () => {
      modal.classList.add("hidden");
    });
  </script>

  <!-- input tag behaviors -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const editBtn = document.getElementById("edit-btn");
      const cancelBtn = document.getElementById("cancel-btn");
      const actionButtons = document.getElementById("action-buttons");
      const input = document.getElementById("edit-workspace-name-field");
      const description = document.getElementById("workspace-description");
      const originalInputValue = input.value;
      const originalDescriptionValue = description.value;
      const editTrigger = document.getElementById("edit-trigger");

      editBtn.addEventListener("click", () => {
        input.removeAttribute("readonly");
        description.removeAttribute("readonly");
        actionButtons.classList.remove("hidden");
        editTrigger.classList.add("hidden");
        input.focus();
      });

      cancelBtn.addEventListener("click", () => {
        input.setAttribute("readonly", true);
        description.setAttribute("readonly", true);
        input.value = originalInputValue;
        description.value = originalDescriptionValue;
        actionButtons.classList.add("hidden");
        editTrigger.classList.remove("hidden");
      });
    });
  </script>

  <!-- show/hide message for 3 sec -->
  <script>
    document.addEventListener("DOMContentLoaded", function () {
      var messageContainer = document.getElementById("message-container");

      if (messageContainer) {
        setTimeout(function () {
          messageContainer.style.opacity = 0;
          setTimeout(function () {
            messageContainer.style.display = "none";
          }, 1000);
        }, 5000);
      }
    });
  </script>

  <!-- preloader for delete action -->
  <script>
    const loader = document.getElementById("loader");
    const deleteForm = document.querySelector(
      `form[action="{% url 'delete_workspace' %}"]`
    );
    const updateForm = document.querySelector(
      `form[action="{% url 'update_workspace' %}"]`
    );

    // Show preloader on form submission
    deleteForm.addEventListener("submit", (e) => {
      loader.classList.remove("hidden"); // Show the loader
      // document.body.style.backgroundColor = '#e0e0e0';
    });

    updateForm.addEventListener("submit", (e) => {
      loader.classList.remove("hidden"); // Show the loader
      // document.body.style.backgroundColor = '#e0e0e0';
    });
  </script>

  <!-- preloader in sidebar link -->
  <script>
    document.addEventListener("DOMContentLoaded", () => {
      const loader = document.getElementById("loader");
      const sidebarLinks = document.querySelectorAll("#sidebar a");

      sidebarLinks.forEach(link => {
        link.addEventListener("click", () => {
          loader.classList.remove("hidden"); // Show the preloader
        });
      });
    });
  </script>

  <script>
    window.addEventListener("pageshow", function (event) {
      // Always hide the loader when coming back to this page
      const loader = document.getElementById("loader");
      if (loader) {
        loader.classList.add("hidden");
      }
    });
  </script>

  <!-- <script>
      if (window.history.replaceState) {
        window.history.replaceState(null, null, window.location.href);
      }
    </script> -->

  <!-- sidebar menu & submenu -->
  <script>
    function toggleSubmenu(targetId, parentElement) {
      const allSubmenus = ["submenu2"]; // Only submenu2 remains

      allSubmenus.forEach((id) => {
        const submenu = document.getElementById(id);
        const parent = submenu.previousElementSibling;
        const arrow = parent.querySelector(".arrow-icon");

        if (id === targetId) {
          const isOpen = submenu.classList.contains("max-h-[500px]");

          if (isOpen) {
            submenu.classList.remove("max-h-[500px]");
            submenu.classList.add("max-h-0");
            arrow.classList.remove("rotate-180");
          } else {
            submenu.classList.remove("max-h-0");
            submenu.classList.add("max-h-[500px]");
            arrow.classList.add("rotate-180");
          }
        } else {
          submenu.classList.remove("max-h-[500px]");
          submenu.classList.add("max-h-0");
          const otherArrow = parent.querySelector(".arrow-icon");
          otherArrow?.classList.remove("rotate-180");
        }
      });
    }
  </script>

  <script>
    const sidebarToggle = document.getElementById("sidebarToggle");
    const sidebar = document.getElementById("sidebar");
    const sidebarBackdrop = document.getElementById("sidebarBackdrop");
    const hamburgerIcon = document.getElementById("hamburgerIcon");
    const closeIcon = document.getElementById("closeIcon");

    sidebarToggle.addEventListener("click", () => {
      sidebar.classList.toggle("-translate-x-full"); // toggle sidebar visibility
      sidebar.classList.toggle("translate-x-0");

      // Toggle the backdrop visibility
      sidebarBackdrop.classList.toggle("hidden");

      // Swap icons for open/close state
      hamburgerIcon.classList.toggle("hidden");
      closeIcon.classList.toggle("hidden");
    });

    // Close sidebar if backdrop is clicked
    sidebarBackdrop.addEventListener("click", () => {
      sidebar.classList.add("-translate-x-full"); // Close sidebar
      sidebar.classList.remove("translate-x-0");
      sidebarBackdrop.classList.add("hidden"); // Hide the backdrop

      // Reset icon visibility
      hamburgerIcon.classList.remove("hidden");
      closeIcon.classList.add("hidden");
    });

  </script>
</body>

</html>